# 业务后台接入腾讯云服务
## 1. 集成云通信账号体系
使用视频互动和消息聊天功能前，您需要预先集成云通信帐号体系，在互动课堂解决方案中我们推荐使用 [独立帐号模式](https://cloud.tencent.com/document/product/269/1508)。
客户端在登录实时音视频 SDK 前，向业务服务器请求登录帐号对应的加密签名，客户端使用签名登录实时音视频的 SDK。

### 客户端登录 SDK
客户端登录 SDK 操作如下：

```objectiveC
// iOS源码
// @"tom"是云通信帐号体系下的用户id
// @"eJx1kMtOg0AYR..."是业务后台生成的用户 tom 的登录签名
[[ILiveLoginManager getInstance] iLiveLogin:@"tom" sig:@"eJx1kMtOg0AYR..." succ:^{
		NSLog(@"login ilivesdk succ");
} failed:^(NSString *module, int errId, NSString *errMsg) {
		NSLog(@"login ilivesdk fail: %@ %d %@", module, errId, errMsg);
}];
```

### 后台 SDK 生成签名
后台 SDK 中生成签名的操作如下：

```php
    static private function gen_sig_linux($sdk_appid, $identifier,  $private_key_path)
    {
        // 创建临时sig文件
        $sig = SigGen::mktemp();
        if(!$sig) {
            return null;
        }

        // 生成sig
        $bit = env('PLATFORM_BIT', '');
        $tool = '/bin/tls_licence_tools';
        if (strcmp($bit, '32') == 0) {
            $tool = '/bin/tls_licence_tools_32';
        }

        $cmd = SDK_PATH . $tool
            . ' ' . 'gen'
            . ' ' . escapeshellarg($private_key_path)
            . ' ' . escapeshellarg($sig)
            . ' ' . escapeshellarg($sdk_appid)
            . ' ' . escapeshellarg($identifier);
        $ret = exec($cmd, $out, $status);
        if ($status != 0)
        {
            return null;
        }

        // 读取sig
        $out=array();
        $cmd = 'cat ' . ' ' . escapeshellarg($sig);
        $ret = exec($cmd, $out, $status);

        SigGen::rmtemp($sig);

        if ($status != 0)
        {
            return null;
        }

        return $out[0];
    }
		
    static private function mktemp()
    {
        $cmd = 'mktemp -t -p ' . SDK_PATH . '/sig login_sig.XXXXXXXXXX';
        $ret = exec($cmd, $out, $status);
        if ($status != 0)
        {
            return null;
        }
        return $out[0];
    }

    static private function rmtemp($tmp)
    {
        $cmd = 'rm -f ' . $tmp;
        $ret = exec($cmd, $out, $status);
        if ($status != 0)
        {
            return false;
        }
        return true;
    }
```

> **注**：
> `$sdk_appid` 由实时音视频控制台分配，`$private_key_path` 是在 [实时音视频控制台](https://console.cloud.tencent.com/rav) 的 App 基础设置页面的 **帐号体系集成** 中下载的私钥文件。

## 2. 集成对象存储服务
老师在开课前，需要业务服务 [生成 COS 临时密钥](https://cloud.tencent.com/document/product/436/14048#.E8.8E.B7.E5.8F.96.E4.B8.B4.E6.97.B6.E5.AF.86.E9.92.A5) 并下发给客户端，互动课堂 App 初始化 COS SDK 后才有权限执行文件的上传操作。

## 后台 SDK 生成签名
后台 SDK 生成签名的操作如下：

```php
require_once dirname(__FILE__) . '/cos-php-sdk-v4/include.php';
use QCloud\Cos\Auth;

class GetCOSSignCmd {
    private $bucket;    //string bucket
    private $filepath;  //string 文件路径，以斜杠开头，例如 /filepath/filename，为文件在此 bucketname 下的全路径
    private $type;  //int 0 - 单次有效， 1 - 多次有效

    /**
     * 处理获取COS签名请求
     * @param string $identifier 用户ID
     * @param string $cmd 服务命令
     * @param string $sub_cmd 子命令
     * @param array $data 请求参数
     */
    public function handle($data){
        // ...
        $config = COSConfig::get_default_config();
        $authApi = new Auth($config['app_id'], $config['secret_id'], $config['secret_key']);  
        
	    // createNonreusableSignature函数生成一次性签名
	    // createReusableSignature函数生成可复用的签名
        if($this->type == 0){
            $sign = $authApi->createNonreusableSignature($this->bucket, $this->filepath);
        }else {
            $expire_time = time() + COSConfig::EXPIRATION;
            $sign = $authApi->createReusableSignature($expire_time, $this->bucket, $this->filepath);
        }
				// ...
    }
}
```


